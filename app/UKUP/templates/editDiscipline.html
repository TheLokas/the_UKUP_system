{% extends "Sidebar.html" %}
{% block content %}
{{ super() }}

<div class="content container-fluid">
  <div class="card rounded-4 shadow-sm" style="background: #F9F9F9">

    <!-- Заголовок карточки -->
    <div class="card-header border-bottom" style="background: #F9F9F9;">
      <h4 class="text-center mb-0">
        <i class="bi bi-journal-plus me-2"></i>Редактирование дисциплины
      </h4>
    </div>

    <!-- Форма -->
    <form method="post" class="p-4" style="padding-bottom: 15px !important; padding-top: 27px !important;">

      <!-- Скрытые поля -->
      <input type="hidden" name="current_year" value="{{ current_year }}">
      <input type="hidden" name="current_direction" value="{{ current_direction.id }}">

      <!-- Название -->
      <div class="form-floating mb-3">
        {{ form.name(class="form-control", id="name") }}
        <label for="name">Название</label>
        <ul id="suggestions" class="list-group position-absolute w-100 shadow" style="z-index: 1000; top: 100%; display: none;"></ul>
      </div>

      <!-- Год и блок -->
      <div class="row">
        <div class="col-md-6">
          <div class="form-floating mb-3">
            {{ form.year_approved(class="form-select", id="year_approved") }}
            <label for="year_approved">Год</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-floating mb-3">
            {{ form.block(class="form-select", id="block") }}
            <label for="block">Блок</label>
          </div>
        </div>
      </div>

      <!-- Модуль и направление -->
      <div class="row">
        <div class="col-md-6">
          <div class="form-floating mb-3">
            {{ form.module(class="form-select", id="module") }}
            <label for="module">Модуль</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-floating mb-3">
            {{ form.direction(class="form-select", id="direction") }}
            <label for="direction">Направление</label>
          </div>
        </div>
      </div>

      <!-- Кафедра и Необходимая дисциплина -->
      <div class="row">
        <div class="col-md-6">
          <div class="form-floating mb-3">
            {{ form.department(class="form-select", id="department") }}
            <label for="department">Кафедра</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-floating mb-3">
            {{ form.required(class="form-select", id="required") }}
            <label for="required">Необходимая дисциплина</label>
          </div>
        </div>
      </div>

      <div class="border-top mt-3" style="margin-left: -1.5rem; margin-right: -1.5rem; padding-top: 15px !important"></div>

      <!-- Кнопка -->
      <div class="row">
        <div class="col-md-4 mx-auto">
          {{ form.submit(value="Сохранить", class="btn w-100 shadow-sm") }}
        </div>
      </div>

    </form>

  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("name");
    const suggestionBox = document.getElementById("suggestions");
    const disciplineNames = {{ discipline_names | tojson }};
    let activeIndex = -1;

    function capitalizeFirstLetter(value) {
      return value
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }

    function showSuggestions(value) {
      const filtered = disciplineNames.filter(name =>
        name.toLowerCase().startsWith(value.toLowerCase())
      );

      suggestionBox.innerHTML = "";
      activeIndex = -1;

      if (filtered.length === 0 || value.trim() === "") {
        suggestionBox.style.display = "none";
        return;
      }

      filtered.forEach((name, index) => {
        const li = document.createElement("li");
        li.classList.add("list-group-item");
        li.textContent = name;

        li.addEventListener("click", () => {
          input.value = name;
          suggestionBox.style.display = "none";
        });

        suggestionBox.appendChild(li);
      });

      suggestionBox.style.display = "block";
    }

    function moveSelection(direction) {
      const items = suggestionBox.querySelectorAll("li");
      if (items.length === 0) return;

      items.forEach(item => item.classList.remove("active"));

      activeIndex += direction;
      if (activeIndex < 0) activeIndex = items.length - 1;
      if (activeIndex >= items.length) activeIndex = 0;

      items[activeIndex].classList.add("active");
      items[activeIndex].scrollIntoView({ block: "nearest" });
    }

    function selectActiveItem() {
      const items = suggestionBox.querySelectorAll("li");
      if (activeIndex >= 0 && items[activeIndex]) {
        input.value = items[activeIndex].textContent;
        suggestionBox.style.display = "none";
      }
    }

    input.addEventListener("input", () => {
      input.value = capitalizeFirstLetter(input.value);
      showSuggestions(input.value);
    });

    input.addEventListener("keydown", (e) => {
      const key = e.key;
      if (key === "ArrowDown") {
        moveSelection(1);
        e.preventDefault();
      } else if (key === "ArrowUp") {
        moveSelection(-1);
        e.preventDefault();
      } else if (key === "Enter") {
        selectActiveItem();
        e.preventDefault();
      }
    });

    input.addEventListener("focus", () => {
      if (input.value.length > 0) {
        showSuggestions(input.value);
      }
    });

    input.addEventListener("blur", () => {
      setTimeout(() => {
        suggestionBox.style.display = "none";
      }, 150);
    });
  });
</script>

<style>
  #suggestions {
    max-height: 200px;
    overflow-y: auto;
    cursor: pointer;
  }

  #suggestions li {
    padding: 8px 12px;
  }

  #suggestions li:hover {
    background-color: #f0f0f0;
  }

  #suggestions li.active {
    background-color: #1967d2;
    color: white;
  }
</style>

{% endblock %}

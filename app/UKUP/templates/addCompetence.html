{% extends "Sidebar.html" %}
{% block content %}
{{ super() }}

<div class="content container-fluid">
  <div class="card rounded-4 shadow-sm" style="background: #F9F9F9">

    <!-- Заголовок карточки -->
    <div class="card-header border-bottom" style="background: #F9F9F9;">
      <h4 class="text-center mb-0">
        <i class="bi bi-gear-fill me-2"></i>Добавление компетенции
      </h4>
    </div>

    <!-- Форма -->
    <form method="post" class="p-4">

      <!-- Скрытые поля -->
      <input type="hidden" id="UK" value="{{ UK }}">
      <input type="hidden" id="OPK" value="{{ OPK }}">
      <input type="hidden" id="PK" value="{{ PK }}">
      <input type="hidden" name="current_year" value="{{ current_year }}">
      <input type="hidden" name="current_direction" value="{{ current_direction.id }}">

      <!-- Название -->
      <div class="form-floating mb-3">
        {{ form.name(class="form-control", id="name", readonly=True) }}
        <label for="name">Название</label>
      </div>

      <!-- Номер и Год -->
      <div class="row">
        <div class="col-md-6">
          <div class="form-floating mb-3">
            {{ form.num(class="form-control", id="num", min=1, step=1, max=100, required=true) }}
            <label for="num">Номер</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-floating mb-3">
            {{ form.year_approved(class="form-select", id="year_approved") }}
            <label for="year_approved">Год</label>
          </div>
        </div>
      </div>

      

        <!-- Тип и Направление -->
        <div class="row">
          <div class="col-md-6">
            <div class="form-floating mb-3">
              {{ form.type(class="form-select", id="type") }}
              <label for="type">Тип</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating mb-3">
              {{ form.direction(class="form-select", id="direction") }}
              <label for="direction">Направление</label>
            </div>
          </div>
        </div>


      <!-- Специальная компетенция-->

        <div class="row">
          <div class="col-md-6">
            <div class="form-group mb-3">
              <input class="form-check-input mt-0" type="checkbox" id="unique_checkbox">
              <label class="form-check-label" for="unique_checkbox">Уникальная компетенция</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating mb-3" id="unique_label" style="display: none;">
              <input class="form-control" type="text" id="unique">
              <label  for="direction">Сокращение для уникальной компетенции</label>
            </div>
          </div>
        </div>

      <!-- Формулировка -->
      <div class="form-floating mb-3">
        {{ form.formulation(class="form-control", style="height:200px;", id="formulation") }}
        <label for="formulation">Формулировка</label>
      </div>

      <!-- Источник (по условию видимости) -->
      <div class="form-floating mb-4" id="source_label" style="display: none;">
        {{ form.source(class="form-control", style="height:85px;", id="source") }}
        <label for="source">Источник</label>
      </div>

      <!-- Кнопка -->
      <div class="row">
        <div class="col-md-4 mx-auto">
          {{ form.submit(value="Сохранить", class="btn btn-success w-100 shadow-sm") }}
        </div>
      </div>

    </form>
  </div>
</div>

<!-- Скрипты -->
<script>
  const type = document.getElementById("type");
  const num = document.getElementById("num");
  const unique_checkbox = document.getElementById("unique_checkbox");
  const unique = document.getElementById("unique")
  const name = document.getElementById("name");

  unique.addEventListener('keydown', function(e) {
    if (!/[a-zA-Zа-яА-яёЁ]/.test(e.key) && e.key !== 'Backspace') {
      e.preventDefault();
    }
  });

  unique_checkbox.addEventListener("change", function(){
    const unique_label = document.getElementById("unique_label");
    if (unique_checkbox.checked){
      unique_label.style.display = "block";
      if (unique_checkbox.checked && unique.value!=""){
        name.value = `${type.value}-${unique.value}-${num.value}`;
      } else {
        name.value = `${type.value}-${num.value}`;
    }
    } else {
      unique_label.style.display = "none";
      name.value = `${type.value}-${num.value}`;
    }
  })

  unique.addEventListener("keyup", function(){
    if (unique_checkbox.checked && unique.value!=""){
      name.value = `${type.value}-${unique.value}-${num.value}`;
    } else {
      name.value = `${type.value}-${num.value}`;
    }
  })

  type.addEventListener("change", function () {
    const source = document.getElementById("source_label");

    let list;
    if (type.value === "УК") list = document.getElementById("UK").value;
    else if (type.value === "ОПК") list = document.getElementById("OPK").value;
    else if (type.value === "ПК") {
      list = document.getElementById("PK").value;
      source.style.display = "block";
    } else {
      list = "[]";
      source.style.display = "none";
    }

    if (type.value !== "ПК") source.style.display = "none";

    if (list === "[]") num.value = 1;
    else {
      const nums = list.slice(1, -1).split(", ");
      num.value = Number(nums.at(-1)) + 1;
    }
    if (unique_checkbox.checked && unique.value!=""){
      name.value = `${type.value}-${unique.value}-${num.value}`;
    } else {
      name.value = `${type.value}-${num.value}`;
    }
  });

  num.addEventListener("keyup", function () {
    if (unique_checkbox.checked && unique.value!=""){
      name.value = `${type.value}-${unique.value}-${num.value}`;
    } else {
      name.value = `${type.value}-${num.value}`;
    }
  });

  window.addEventListener("load", function () {
    const UK = document.getElementById("UK").value;
    const name = document.getElementById("name");
    const numInput = document.getElementById("num");

    if (UK === "[]") numInput.value = 1;
    else {
      const nums = UK.slice(1, -1).split(", ");
      numInput.value = Number(nums.at(-1)) + 1;
    }
    if (unique_checkbox.checked && unique.value!=""){
      name.value = `${type.value}-${unique.value}-${num.value}`;
    } else {
      name.value = `${type.value}-${num.value}`;
    }
  });
</script>

{% endblock %}

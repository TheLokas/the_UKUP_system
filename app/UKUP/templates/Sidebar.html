{% extends "Header.html" %}
{% block content %}
<div class="row nav"  style="min-width:700px; ">
  <nav class="navbar navbar-expand-lg bg-body-tertiary" id="navbar">
  <div class="container-fluid">
    <div class="navbar-collapse" style="justify-content: center;" id="navbarSupportedContent">

      <form class="navbutton" action="/UKUP/discipline" method="get">
        <input name="year" id="year1" type="hidden" value="{{ current_year }}">
        <input name="direction" id="direction1" type="hidden" value="{{ current_direction.id }}">
      <input type="submit" class="btn btn-secondary btn-lg" value="Дисциплины">
      </form>
      <form class="navbutton" action="/UKUP/competence" method="get">
        <input name="year" id="year2" type="hidden" value="{{ current_year }}">
        <input name="direction" id="direction2" type="hidden" value="{{ current_direction.id }}">
      <input type="submit" class="btn btn-secondary btn-lg" value="Компетенции">
      </form>
      <form class="navbutton" action="/UKUP/ze" method="get">
        <input name="year" id="year3" type="hidden" value="{{ current_year }}">
        <input name="direction" id="direction3" type="hidden" value="{{ current_direction.id }}">
      <input type="submit" class="btn btn-secondary btn-lg" value="Зачетные единицы">
      </form>

      <div class="navbutton">
        <ul class="navbar-nav  mb-2 mb-lg-0 justify-content-end">
          <li class="nav-item dropdown nav-button">
            <a class="nav-link dropdown-toggle btn btn-secondary btn-lg"  role="button" data-bs-toggle="dropdown" aria-expanded="false">Отчёты</a>
            <ul class="dropdown-menu year">
              <li><span style="cursor: pointer">
                <form action="/UKUP/report/competence/all" method="get">
                <input name="year" id="year3" type="hidden" value="{{ current_year }}">
                <input name="direction" id="direction3" type="hidden" value="{{ current_direction.id }}">
                <input type="submit" class="dropdown-item" value="Компетенции">
              </form></span></li>

              <li><span style="cursor: pointer"><form action="/UKUP/report/competence/УК" method="get">
                <input name="year" id="year4" type="hidden" value="{{ current_year }}">
                <input name="direction" id="direction4" type="hidden" value="{{ current_direction.id }}">
                <input type="submit" class="dropdown-item" value="УК">
              </form></span></li>

              <li><span style="cursor: pointer"><form action="/UKUP/report/competence/ОПК" method="get">
                <input name="year" id="year5" type="hidden" value="{{ current_year }}">
                <input name="direction" id="direction5" type="hidden" value="{{ current_direction.id }}">
                <input type="submit" class="dropdown-item" value="ОПК">
              </form></span></li>

              <li><span style="cursor: pointer"><form action="/UKUP/report/competence/ПК" method="get">
                <input name="year" id="year6" type="hidden" value="{{ current_year }}">
                <input name="direction" id="direction6" type="hidden" value="{{ current_direction.id }}">
                <input type="submit" class="dropdown-item" value="ПК">
              </form></span></li>

              <li><span style="cursor: pointer"><form action="/UKUP/report/matrix" method="get">
                <input name="year" id="year7" type="hidden" value="{{ current_year }}">
                <input name="direction" id="direction7" type="hidden" value="{{ current_direction.id }}">
                <input type="submit" class="dropdown-item" value="Матрица">
              </form></span></li>
              
            </ul>
          </li>
        </ul>
      </div>

      <form class="navbutton" id="form" method="get">
        <input name="year" id="year" type="hidden" value="{{ current_year }}">
        <input name="direction" id="direction" type="hidden" value="{{ current_direction.id }}">
      <ul class="navbar-nav  mb-2 mb-lg-0 justify-content-end">
        <li class="nav-item dropdown nav-button">
          <a class="nav-link dropdown-toggle btn btn-secondary btn-lg"  role="button" data-bs-toggle="dropdown" aria-expanded="false">
            {{ current_year }}
          </a>
          <ul class="dropdown-menu year">
            {% for year in years %}
            <li><span style="cursor: pointer" class="dropdown-item">{{  year  }}</span></li>
            {% endfor %}
          </ul>
        </li>
         <li class="nav-item" style="width:20px;">
        </li>
        <li class="nav-item dropdown nav-button">
          <a class="nav-link dropdown-toggle btn btn-secondary btn-lg" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            {{ current_direction.name }}
          </a>
          <ul class="dropdown-menu direction">
            {% for direction in directions %}
            <li><span id="{{ direction.id }}" style="cursor: pointer" class="dropdown-item">{{  direction.name  }}</span></li>
            {% endfor %}
          </ul>
        </li>
        </li>
      </ul>
        </form>
       <form class="navbutton" id="form2" method="get" action="/UKUP/{{ type }}/add">
        <input name="year" id="year0" type="hidden" value="{{ current_year }}">
        <input name="direction" id="direction0" type="hidden" value="{{ current_direction.id }}">
         <input type="submit" class="btn btn-secondary btn-lg" value="Добавить">
       </form>
    </div>



<div class="navbutton" style="display: inline-block;">  <!-- или d-inline-block -->
  <button type="button" class="btn btn-secondary btn-lg" data-bs-toggle="modal" data-bs-target="#checkboxModal">
    Открыть выбор
  </button>
</div>
  </div>



</nav>
<script>
var listYears = document.querySelectorAll('.year li > span');
var listDirections = document.querySelectorAll('.direction li > span');

listYears.forEach((item, index) => {
  item.addEventListener('click', (event) => {
     let year = document.getElementById("year");
     let form = document.getElementById("form");
     year.value = item.innerHTML;
     form.submit()
  });
})

listDirections.forEach((item, index) => {
  item.addEventListener('click', (event) => {
     let direction = document.getElementById("direction");
     let form = document.getElementById("form");
     direction.value = item.id;
     form.submit()
  });
})
</script>
</div>
<div class="row" style="display:flex; justify-content: center;">
  <!-- margin-right:5px; -->

<!-- Модальное окно с чекбоксами -->
<div class="modal fade" id="checkboxModal" tabindex="-1" aria-labelledby="checkboxModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="checkboxModalLabel">Копирование данных на следующий год</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="sourceYear" class="form-label">Из какого года копировать:</label>
          <select class="form-select" id="sourceYear">
            {% for year in years %}
            <option value="{{ year }}">{{ year }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="targetYear" class="form-label">В какой год копировать:</label>
          <input type="number" class="form-control" id="targetYear"
                 value="{{ current_year|int + 1 }}">
        </div>
        <form id="checkboxesForm">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="disciplines" id="option1" checked>
            <label class="form-check-label" for="option1">
              Дисциплины
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="competences" id="option2" checked>
            <label class="form-check-label" for="option2">
              Компетенции
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="indicators" id="option3" checked>
            <label class="form-check-label" for="option3">
              Индикаторы
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="ze" id="option4" checked>
            <label class="form-check-label" for="option4">
              Зачётные единицы
            </label>
          </div>
                <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="confirmSelection">Копировать</button>
      </div>
        </form>
      </div>
    </div>
  </div>
</div>


<script>
document.getElementById('confirmSelection').addEventListener('click', async function() {
    const btn = this;
    const sourceYear = document.getElementById('sourceYear').value;
    const targetYear = document.getElementById('targetYear').value;

    // Получаем выбранные опции
    const selectedOptions = Array.from(
        document.querySelectorAll('#checkboxesForm input[type="checkbox"]:checked')
    ).map(checkbox => checkbox.value);

    // Валидация
    if (selectedOptions.length === 0) {
        alert('Пожалуйста, выберите хотя бы один элемент для копирования');
        return;
    }

    if (sourceYear === targetYear) {
        alert('Годы должны отличаться');
        return;
    }

    // Показать состояние загрузки
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Копирование...';

    try {
        // Отправляем запрос на сервер
        const response = await fetch('/UKUP/copy-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sourceYear: sourceYear,
                targetYear: targetYear,
                entities: selectedOptions
            })
        });

        const result = await response.json();

        if (!response.ok) throw new Error(result.error || 'Ошибка сервера');

        alert('Данные успешно скопированы!');
        window.location.reload();  // Обновить страницу

    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при копировании: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Копировать';
        bootstrap.Modal.getInstance(document.getElementById('checkboxModal')).hide();
    }
});
</script>


{% endblock %}
{% extends "Header.html" %}
{% block content %}
<div class="row nav"  style="min-width:700px; ">
  <nav class="navbar navbar-expand-lg bg-body-tertiary" id="navbar">
  <div class="container-fluid">
    <div class="navbar-collapse" style="justify-content: center;" id="navbarSupportedContent">

      <form class="navbutton" action="/UKUP/discipline" method="get">
        <input name="year" id="year1" type="hidden" value="{{ current_year }}">
        <input name="direction" id="direction1" type="hidden" value="{{ current_direction.id }}">
      <input type="submit" class="btn btn-secondary btn-lg" value="Дисциплины">
      </form>
      <form class="navbutton" action="/UKUP/competence" method="get">
        <input name="year" id="year2" type="hidden" value="{{ current_year }}">
        <input name="direction" id="direction2" type="hidden" value="{{ current_direction.id }}">
      <input type="submit" class="btn btn-secondary btn-lg" value="Компетенции">
      </form>
      <form class="navbutton" action="/UKUP/ze" method="get">
        <input name="year" id="year3" type="hidden" value="{{ current_year }}">
        <input name="direction" id="direction3" type="hidden" value="{{ current_direction.id }}">
      <input type="submit" class="btn btn-secondary btn-lg" value="Зачетные единицы">
      </form>

      <div class="navbutton">
        <ul class="navbar-nav  mb-2 mb-lg-0 justify-content-end">
          <li class="nav-item dropdown nav-button">
            <a class="nav-link dropdown-toggle btn btn-secondary btn-lg"  role="button" data-bs-toggle="dropdown" aria-expanded="false">Отчёты</a>
            <ul class="dropdown-menu year">
              <li><span style="cursor: pointer">
                <form action="/UKUP/report/competence/all" method="get">
                <input name="year" id="year3" type="hidden" value="{{ current_year }}">
                <input name="direction" id="direction3" type="hidden" value="{{ current_direction.id }}">
                <input type="submit" class="dropdown-item" value="Компетенции">
              </form></span></li>

              <li><span style="cursor: pointer"><form action="/UKUP/report/competence/УК" method="get">
                <input name="year" id="year4" type="hidden" value="{{ current_year }}">
                <input name="direction" id="direction4" type="hidden" value="{{ current_direction.id }}">
                <input type="submit" class="dropdown-item" value="УК">
              </form></span></li>

              <li><span style="cursor: pointer"><form action="/UKUP/report/competence/ОПК" method="get">
                <input name="year" id="year5" type="hidden" value="{{ current_year }}">
                <input name="direction" id="direction5" type="hidden" value="{{ current_direction.id }}">
                <input type="submit" class="dropdown-item" value="ОПК">
              </form></span></li>

              <li><span style="cursor: pointer"><form action="/UKUP/report/competence/ПК" method="get">
                <input name="year" id="year6" type="hidden" value="{{ current_year }}">
                <input name="direction" id="direction6" type="hidden" value="{{ current_direction.id }}">
                <input type="submit" class="dropdown-item" value="ПК">
              </form></span></li>

              <li><span style="cursor: pointer"><form action="/UKUP/report/matrix" method="get">
                <input name="year" id="year7" type="hidden" value="{{ current_year }}">
                <input name="direction" id="direction7" type="hidden" value="{{ current_direction.id }}">
                <input type="submit" class="dropdown-item" value="Матрица">
              </form></span></li>

            </ul>
          </li>
        </ul>
      </div>

      <form class="navbutton" id="form" method="get">
        <input name="year" id="year" type="hidden" value="{{ current_year }}">
        <input name="direction" id="direction" type="hidden" value="{{ current_direction.id }}">
      <ul class="navbar-nav  mb-2 mb-lg-0 justify-content-end">
        <li class="nav-item dropdown nav-button">
          <a class="nav-link dropdown-toggle btn btn-secondary btn-lg"  role="button" data-bs-toggle="dropdown" aria-expanded="false">
            {{ current_year }}
          </a>
          <ul class="dropdown-menu year">
            {% for year in years %}
            <li><span style="cursor: pointer" class="dropdown-item">{{  year  }}</span></li>
            {% endfor %}
          </ul>
        </li>
         <li class="nav-item" style="width:20px;">
        </li>
        <li class="nav-item dropdown nav-button" style="width: 120px;">
          <style>
            .btn.text-truncate.dropdown-toggle::after {
              position: absolute;
              right: 10px;
              top: 13px;
              overflow: visible !important;
            }
          </style>

          <a class="nav-link dropdown-toggle btn btn-secondary btn-lg text-truncate " href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="padding-left: 0;">
            {{ current_direction.name }}
          </a>

          <ul class="dropdown-menu direction">
            {% for direction in directions %}
            <li><span id="{{ direction.id }}" style="cursor: pointer" class="dropdown-item">{{  direction.name  }}</span></li>
            {% endfor %}
          </ul>
        </li>
        </li>
      </ul>
        </form>
       <div class="navbutton">
  <ul class="navbar-nav mb-2 mb-lg-0 justify-content-end">
    <li class="nav-item dropdown nav-button">
      <a class="nav-link dropdown-toggle btn btn-secondary btn-lg" role="button" data-bs-toggle="dropdown" aria-expanded="false">Действия</a>
      <ul class="dropdown-menu">
        <!-- Удалено кнопка "Добавить" из этого меню -->
        <!-- Кнопка "Удалить данные" -->
        <li>
          <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#deleteModal">
            Удалить данные
          </button>
        </li>

        <!-- Кнопка "Открыть выбор" -->
        <li>
          <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#checkboxModal">
            Копировать данные
          </button>
        </li>

        {% if request.endpoint == "UKUP.discipline" %}
        <li>
          <form id="form2" method="get" action="/UKUP/{{ type }}/add" style="margin: 0; border: 0;">
                      <input name="year" type="hidden" value="{{ current_year }}">
                      <input name="direction" type="hidden" value="{{ current_direction.id }}">
                      <input type="submit" class="dropdown-item" value="Добавить дисциплину">
                  </form>
        </li>

        {% endif %}
                {% if request.endpoint == "UKUP.competence" %}

        <li>
          <form id="form3" method="get" action="/UKUP/{{ type }}/add" style="margin: 0; border: 0;">
                      <input name="year" type="hidden" value="{{ current_year }}">
                      <input name="direction" type="hidden" value="{{ current_direction.id }}">
                      <input type="submit" class="dropdown-item" value="Добавить компетенцию">
                  </form>
        </li>
        {% endif %}
        <li> <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#manageModal"> Управление сущностями </button> </li>
      </ul>
    </li>
  </ul>
</div>
<!-- Рядом с кнопкой "Открыть выбор" -->
  </div>



</nav>

<style>
  /* Если нужно специально "опустить" содержимое страницы ниже панели */
  .content {
    margin-top: 4px; /* Или сколько у тебя там высота панели */
  }
</style>


<script>
var listYears = document.querySelectorAll('.year li > span');
var listDirections = document.querySelectorAll('.direction li > span');

listYears.forEach((item, index) => {
  item.addEventListener('click', (event) => {
     let year = document.getElementById("year");
     let form = document.getElementById("form");
     year.value = item.innerHTML;
     form.submit()
  });
})

listDirections.forEach((item, index) => {
  item.addEventListener('click', (event) => {
     let direction = document.getElementById("direction");
     let form = document.getElementById("form");
     direction.value = item.id;
     form.submit()
  });
})
</script>
</div>
<div class="row" style="display:flex; justify-content: center;">
  <!-- margin-right:5px; -->

<!-- Модальное окно с чекбоксами -->
<div class="modal fade" id="checkboxModal" tabindex="-1" aria-labelledby="checkboxModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="checkboxModalLabel">Копирование данных на следующий год</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Годы копирования в одной строке -->
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label for="sourceYear" class="form-label">Из какого года копировать:</label>
            <select class="form-select" id="sourceYear">
              {% for year in years %}
              <option value="{{ year }}">{{ year }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="targetYear" class="form-label">В какой год копировать:</label>
            <input type="number" class="form-control" id="targetYear" value="{{ current_year|int + 1 }}">
          </div>
        </div>

        <!-- Таблица с направлениями -->
        <div class="mb-4">
          <h6>Выберите направления для копирования:</h6>
          <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem;">
            <table class="table table-sm table-hover mb-0">
              <thead class="sticky-top bg-light">
                <tr>
                  <th width="40px"><input type="checkbox" id="selectAllDirections"></th>
                  <th>Направление</th>
                  <th>Код</th>
                </tr>
              </thead>
              <tbody id="directionsTable">
                {% for direction in directions %}
                <tr>
                  <td><input type="checkbox" class="direction-checkbox" value="{{ direction.id }}" checked></td>
                  <td>{{ direction.name }}</td>
                  <td>{{ direction.code }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="mb-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="overwriteData">
          <label class="form-check-label" for="overwriteData">
            <strong>Перезаписать существующие данные</strong>
          </label>
          <small class="form-text text-muted d-block">
            При включении этой опции существующие данные в целевом году будут перезаписаны
          </small>
        </div>
      </div>

        <!-- Чекбоксы в две колонки -->
        <div class="row g-2">
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAllOptions">
              <label class="form-check-label" for="selectAllOptions">
                Выбрать всё
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="disciplines" id="option1">
              <label class="form-check-label" for="option1">
                Дисциплины
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="competences" id="option2">
              <label class="form-check-label" for="option2">
                Компетенции
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="indicators" id="option3">
              <label class="form-check-label" for="option3">
                Индикаторы
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="ze" id="option4">
              <label class="form-check-label" for="option4">
                Зачётные единицы
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="dependent_disciplines" id="option5">
              <label class="form-check-label" for="option5">
                Зависимые дисциплины
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="discipline_indicator_links" id="option6">
              <label class="form-check-label" for="option6">
                Связи дисциплина-индикатор
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="discipline_competence_links" id="option7">
              <label class="form-check-label" for="option7">
                Связи дисциплина-компетенция
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Кнопки по краям -->
    <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px;">
            <button type="button" class="btn btn-primary" style="width: 120px;" id="confirmSelection">
        <i class="bi bi-files me-1"></i> Копировать
      </button>
      <button type="button" class="btn btn-outline-secondary" style="width: 120px;" data-bs-dismiss="modal">
        <i class="bi bi-x-lg me-1"></i> Отмена
      </button>
    </div>
    </div>
  </div>
</div>


<!-- Модальное окно для удаления -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">Удаление данных</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Год для удаления -->
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label for="deleteYear" class="form-label">Год данных для удаления:</label>
            <select class="form-select" id="deleteYear">
              {% for year in years %}
              <option value="{{ year }}">{{ year }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Таблица с направлениями -->
        <div class="mb-4">
          <h6>Выберите направления для удаления:</h6>
          <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem;">
            <table class="table table-sm table-hover mb-0">
              <thead class="sticky-top bg-light">
                <tr>
                  <th width="40px"><input type="checkbox" id="selectAllDirectionsDelete"></th>
                  <th>Направление</th>
                  <th>Код</th>
                </tr>
              </thead>
              <tbody id="directionsTableDelete">
                {% for direction in directions %}
                <tr>
                  <td><input type="checkbox" class="direction-checkbox-delete" value="{{ direction.id }}" checked></td>
                  <td>{{ direction.name }}</td>
                  <td>{{ direction.code }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Чекбоксы для выбора типов данных -->
        <!-- В модальном окне удаления замените блок с чекбоксами на: -->
        <div class="row g-2">
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAllOptionsDelete">
              <label class="form-check-label" for="selectAllOptionsDelete">
                Выбрать всё
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input element-delete-checkbox" type="checkbox" value="disciplines" id="deleteOption1" checked>
              <label class="form-check-label" for="deleteOption1">
                Дисциплины
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input element-delete-checkbox" type="checkbox" value="competences" id="deleteOption2" checked>
              <label class="form-check-label" for="deleteOption2">
                Компетенции
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input element-delete-checkbox" type="checkbox" value="indicators" id="deleteOption3" checked>
              <label class="form-check-label" for="deleteOption3">
                Индикаторы
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input element-delete-checkbox" type="checkbox" value="ze" id="deleteOption4" checked>
              <label class="form-check-label" for="deleteOption4">
                Зачётные единицы
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input element-delete-checkbox" type="checkbox" value="dependent_disciplines" id="deleteOption5" checked>
              <label class="form-check-label" for="deleteOption5">
                Зависимые дисциплины
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input element-delete-checkbox" type="checkbox" value="competence_discipline_links" id="deleteOption6" checked>
              <label class="form-check-label" for="deleteOption6">
                Связи компетенция-дисциплина
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input element-delete-checkbox" type="checkbox" value="indicator_discipline_links" id="deleteOption7" checked>
              <label class="form-check-label" for="deleteOption7">
                Связи индикатор-дисциплина
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px;">
        <button type="button" class="btn btn-danger" style="width: 120px;" id="confirmDelete">
          <i class="bi bi-trash me-1"></i> Удалить
        </button>
        <button type="button" class="btn btn-outline-secondary" style="width: 120px;" data-bs-dismiss="modal">
          <i class="bi bi-x-lg me-1"></i> Отмена
        </button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="manageModal" tabindex="-1" aria-labelledby="manageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4 shadow">

      <div class="modal-header">
        <h5 class="modal-title" id="manageModalLabel">Добавление сущности</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Переключатель режимов -->
        <div class="btn-group mb-4" role="group" aria-label="Режим">
          <button type="button" class="btn btn-outline-primary active" id="btnAdd" onclick="switchManageMode('add')">Добавить</button>
          <button type="button" class="btn btn-outline-danger" id="btnDelete" onclick="switchManageMode('delete')">Удалить</button>
        </div>

        <!-- Тип сущности -->
        <div class="mb-3">
          <label for="entityType" class="form-label">Тип сущности</label>
          <select id="entityType" class="form-select" onchange="loadEntities()">
            <option value="block">Блок</option>
            <option value="module">Модуль</option>
            <option value="department">Кафедра</option>
            <option value="direction">Направление</option>
          </select>
        </div>

        <!-- Список сущностей -->
        <div id="entityList" class="mb-3">
          <!-- Подгружается динамически -->
        </div>

        <!-- Поле ввода названия новой сущности -->
        <div id="addInputGroup" class="mb-3">
          <label for="newEntityName" class="form-label">Название новой сущности</label>
          <input type="text" class="form-control" id="newEntityName" placeholder="Введите название">
        </div>
      </div>

      <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px;">
        <button id="submitButton" type="button" class="btn btn-primary">
          <i class="bi bi-plus-circle me-1"></i> Добавить
        </button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-lg me-1"></i> Отмена
        </button>
      </div>

    </div>
  </div>
</div>



<script>
  let currentTab = 'add';

  const dummyData = {
    block: ['Блок A', 'Блок B'],
    module: ['Модуль 1', 'Модуль 2'],
    department: ['Кафедра математики', 'Кафедра физики'],
    direction: ['Информатика', 'Физика']
  };

  function switchTab(tab) {
    currentTab = tab;
    document.getElementById('add-tab').classList.toggle('active', tab === 'add');
    document.getElementById('delete-tab').classList.toggle('active', tab === 'delete');
    document.getElementById('submitButton').textContent = tab === 'add' ? 'Добавить' : 'Удалить';
    document.getElementById('addInputGroup').style.display = tab === 'add' ? 'block' : 'none';
    loadEntities();
  }

  function loadEntities() {
    const type = document.getElementById('entityType').value;
    const container = document.getElementById('entityList');
    const entities = dummyData[type] || [];

    if (currentTab === 'add') {
      container.innerHTML = '<strong>Существующие:</strong><ul>' +
        entities.map(e => `<li>${e}</li>`).join('') + '</ul>';
    } else {
      container.innerHTML = '<strong>Удалить следующие:</strong>' +
        entities.map(e => `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${e}" id="check-${e}">
            <label class="form-check-label" for="check-${e}">${e}</label>
          </div>
        `).join('');
    }
  }
  function switchManageMode(mode) {
    const title = document.getElementById('manageModalLabel');
    const submitButton = document.getElementById('submitButton');
    const addInputGroup = document.getElementById('addInputGroup');

    if (mode === 'add') {
      title.textContent = 'Добавление сущности';
      submitButton.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Добавить';
      addInputGroup.style.display = 'block';
      document.getElementById('btnAdd').classList.add('active');
      document.getElementById('btnDelete').classList.remove('active');
    } else {
      title.textContent = 'Удаление сущности';
      submitButton.innerHTML = '<i class="bi bi-trash me-1"></i> Удалить';
      addInputGroup.style.display = 'none';
      document.getElementById('btnAdd').classList.remove('active');
      document.getElementById('btnDelete').classList.add('active');
    }

    loadEntities(); // обновление списка
  }
  // При открытии окна — загрузить список
  document.getElementById('manageModal').addEventListener('shown.bs.modal', loadEntities);
</script>



<style>
  /* Стили для подсветки чекбоксов при наведении */
  .form-check:hover {
    background-color: #f8f9fa;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }

  .form-check-input:hover {
    cursor: pointer;
  }

  .form-check-label:hover {
    cursor: pointer;
    color: #0d6efd;
  }

  /* Стили для таблицы направлений */
  .direction-row:hover {
    background-color: #f8f9fa;
  }

  .direction-checkbox:hover {
    cursor: pointer;
  }

  /* Анимация для кнопок */
  .btn {
    transition: all 0.2s ease;
  }

  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
</style>


<script>
// Функция для обновления состояния чекбокса "Выбрать все направления"
function updateSelectAllDirections() {
    const checkboxes = document.querySelectorAll('.direction-checkbox');
    const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(checkbox => checkbox.checked);
    document.getElementById('selectAllDirections').checked = allChecked;
}

// Функция для обновления состояния чекбокса "Выбрать всё" (основные опции)
function updateSelectAllOptions() {
    const mainCheckboxes = document.querySelectorAll('#option1, #option2, #option3, #option4, #option5, #option6, #option7');
    const allChecked = mainCheckboxes.length > 0 && Array.from(mainCheckboxes).every(cb => cb.checked);
    document.getElementById('selectAllOptions').checked = allChecked;
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация состояний чекбоксов
    updateSelectAllDirections();
    updateSelectAllOptions();

    // Обработчик для "Выбрать все направления"
    document.getElementById('selectAllDirections').addEventListener('change', function() {
        document.querySelectorAll('.direction-checkbox').forEach(checkbox => {
            checkbox.checked = this.checked;
            // Добавляем анимацию при изменении состояния
            checkbox.parentElement.parentElement.style.transition = 'background-color 0.3s';
            checkbox.parentElement.parentElement.style.backgroundColor = this.checked ? '#e9f5ff' : '';
            setTimeout(() => {
                checkbox.parentElement.parentElement.style.transition = '';
                checkbox.parentElement.parentElement.style.backgroundColor = '';
            }, 300);
        });
    });

    // Обработчики для чекбоксов направлений
    document.querySelectorAll('.direction-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectAllDirections();
            // Визуальный эффект при изменении
            this.parentElement.parentElement.style.backgroundColor = this.checked ? '#e9f5ff' : '';
            setTimeout(() => {
                this.parentElement.parentElement.style.backgroundColor = '';
            }, 300);
        });
    });

    // Обработчик для "Выбрать всё" (основные опции)
    document.getElementById('selectAllOptions').addEventListener('change', function() {
        const mainCheckboxes = document.querySelectorAll('#option1, #option2, #option3, #option4, #option5, #option6, #option7');
        mainCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
            // Визуальный эффект при изменении
            const label = checkbox.nextElementSibling;
            label.style.color = this.checked ? '#0d6efd' : '';
            setTimeout(() => {
                label.style.color = '';
            }, 300);
        });

        // Особые правила для связанных чекбоксов
        if (this.checked) {
            document.getElementById('option1').checked = true; // Дисциплины
        }
    });

    // Обработчики для основных чекбоксов
    const mainCheckboxes = document.querySelectorAll('#option1, #option2, #option3, #option4, #option5, #option6, #option7');
    mainCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectAllOptions();

            // Визуальный эффект при изменении
            const label = this.nextElementSibling;
            label.style.fontWeight = '600';
            setTimeout(() => {
                label.style.fontWeight = '';
            }, 300);

            // Специальные правила для связанных чекбоксов
        // 1. Правила для дисциплин и зачетных единиц
        if (checkbox.id === 'option1' && !this.checked) {
            document.getElementById('option4').checked = false; // Снять ЗЕ если сняли Дисциплины
            document.getElementById('option5').checked = false; // Снять зависимые дисциплины
            document.getElementById('option6').checked = false; // Снять связи дисциплина-индикатор
            document.getElementById('option7').checked = false; // Снять связи дисциплина-компетенция
        }
        if (checkbox.id === 'option4' && this.checked) {
            document.getElementById('option1').checked = true; // Выбрать Дисциплины при выборе ЗЕ
        }

        // 2. Правила для зависимых дисциплин
        if (checkbox.id === 'option5' && this.checked) {
            document.getElementById('option1').checked = true; // Выбрать Дисциплины при выборе зависимых
        }

        // 3. Правила для компетенций и индикаторов
        if (checkbox.id === 'option2' && !this.checked) {
            document.getElementById('option3').checked = false; // Снять индикаторы если сняли компетенции
            document.getElementById('option6').checked = false; // Снять связи дисциплина-индикатор
            document.getElementById('option7').checked = false; // Снять связи дисциплина-компетенция
        }
        if (checkbox.id === 'option3' && this.checked) {
            document.getElementById('option2').checked = true; // Выбрать компетенции при выборе индикаторов
        }

        // 4. Правила для связей дисциплина-индикатор (option6)
        if (checkbox.id === 'option6' && this.checked) {
            document.getElementById('option1').checked = true; // Дисциплины
            document.getElementById('option2').checked = true; // Компетенции
            document.getElementById('option3').checked = true; // Индикаторы
            document.getElementById('option7').checked = true; // Дисциплина-компетенция
        }

        // 5. Правила для связей дисциплина-компетенция (option7)
        if (checkbox.id === 'option7' && this.checked) {
            document.getElementById('option1').checked = true; // Дисциплины
            document.getElementById('option2').checked = true; // Компетенции
        }
        // 6. Если убрали индикаторы или компетенции — снять дисциплина-индикатор
        if ((checkbox.id === 'option2' || checkbox.id === 'option3') && !this.checked) {
            document.getElementById('option6').checked = false; // Убираем дисциплина-индикатор
        }

        // 7. При выборе дисциплина-индикатор — проверяем, выбраны ли индикаторы и компетенции
        if (checkbox.id === 'option6' && this.checked) {
            const indicatorChecked = document.getElementById('option3').checked;
            const competenceChecked = document.getElementById('option2').checked;
            if (!indicatorChecked || !competenceChecked) {
                alert('Нельзя выбрать "Дисциплина–Индикатор" без включённых "Индикаторов" и "Компетенций".');
                checkbox.checked = false; // Снять галочку
                return; // Не продолжаем выполнение

            }
        }
        // 8. Если сняли "Связи дисциплина–компетенция" — снять "Дисциплина–Индикатор", если он выбран
        if (checkbox.id === 'option7' && !this.checked) {
            const indicatorDisciplineCheckbox = document.getElementById('option6');
            if (indicatorDisciplineCheckbox.checked) {
                indicatorDisciplineCheckbox.checked = false;
            }
        }


        });
    });

    // Обработчик кнопки "Копировать"
    document.getElementById('confirmSelection').addEventListener('click', async function() {
        const btn = this;
        const sourceYear = document.getElementById('sourceYear').value;
        const targetYear = document.getElementById('targetYear').value;
        const overwriteData = document.getElementById('overwriteData').checked;
        // Получаем выбранные направления
        const selectedDirections = Array.from(
            document.querySelectorAll('.direction-checkbox:checked')
        ).map(checkbox => checkbox.value);

        // Получаем выбранные опции
        const selectedOptions = Array.from(
            document.querySelectorAll('#option1:checked, #option2:checked, #option3:checked, #option4:checked, #option5:checked, #option6:checked, #option7:checked')
        ).map(checkbox => checkbox.value);

        // Валидация
        if (selectedDirections.length === 0) {
            alert('Пожалуйста, выберите хотя бы одно направление');
            return;
        }

        if (selectedOptions.length === 0) {
            alert('Пожалуйста, выберите хотя бы один элемент для копирования');
            return;
        }

        if (sourceYear === targetYear) {
            alert('Годы должны отличаться');
            return;
        }

        // Показать состояние загрузки
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Копирование...';

        try {
            const response = await fetch('/UKUP/copy-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sourceYear: sourceYear,
                    targetYear: targetYear,
                    directions: selectedDirections,
                    entities: selectedOptions,
                    overwrite: overwriteData  // Добавляем параметр перезаписи
                })
            });

            const result = await response.json();

            if (!response.ok) throw new Error(result.error || 'Ошибка сервера');

            // Визуальный эффект при успешном копировании
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.classList.remove('btn-success');
            }, 2000);

            alert('Данные успешно скопированы!');
            window.location.reload();

        } catch (error) {
            console.error('Ошибка:', error);
            // Визуальный эффект при ошибке
            btn.classList.add('btn-danger');
            setTimeout(() => {
                btn.classList.remove('btn-danger');
            }, 2000);
            alert('Ошибка при копировании: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-files me-1"></i> Копировать';
        }
    });
});

</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик кнопки удаления
    document.getElementById('confirmDelete').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Удаление...';

        try {
            const year = document.getElementById('deleteYear').value;
            const directionCheckboxes = document.querySelectorAll('.direction-checkbox-delete:checked');
            const directions = Array.from(directionCheckboxes).map(cb => cb.value);
            const elements = Array.from(document.querySelectorAll('.element-delete-checkbox:checked')).map(cb => cb.value);

            if (directions.length === 0) throw new Error('Выберите хотя бы одно направление');
            if (elements.length === 0) throw new Error('Выберите хотя бы один элемент для удаления');

            const response = await fetch('/UKUP/delete-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ year: year, directions: directions, entities: elements })
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Ошибка сервера');

            alert('Данные успешно удалены!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            window.location.reload();

        } catch (error) {
            console.error('Ошибка при удалении:', error);
            alert('Ошибка: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-trash me-1"></i> Удалить выбранное';
        }
    });

    // "Выбрать все" направления
    document.getElementById('selectAllDirectionsDelete').addEventListener('change', function() {
        document.querySelectorAll('.direction-checkbox-delete').forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    // "Выбрать все" элементы
    document.getElementById('selectAllOptionsDelete').addEventListener('change', function() {
        document.querySelectorAll('.element-delete-checkbox').forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    // Обновление состояния чекбокса "выбрать всё"
    function updateSelectAllDirectionsDelete() {
        const checkboxes = document.querySelectorAll('.direction-checkbox-delete');
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        document.getElementById('selectAllDirectionsDelete').checked = allChecked;
    }

    function updateSelectAllOptionsDelete() {
        const checkboxes = document.querySelectorAll('.element-delete-checkbox');
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        document.getElementById('selectAllOptionsDelete').checked = allChecked;
    }

    // Обновляем при открытии модального окна
    document.getElementById('deleteModal').addEventListener('shown.bs.modal', function () {
        updateSelectAllDirectionsDelete();
        updateSelectAllOptionsDelete();
    });

    // Получаем все чекбоксы
    const checkboxMap = {
        disciplines: document.getElementById('deleteOption1'),
        ze: document.getElementById('deleteOption4'),
        dependent_disciplines: document.getElementById('deleteOption5'),
        competence_discipline_links: document.getElementById('deleteOption6'),
        indicator_discipline_links: document.getElementById('deleteOption7'),
        competences: document.getElementById('deleteOption2'),
        indicators: document.getElementById('deleteOption3'),
    };

    // Функция для обновления состояния чекбокса "Выбрать всё"
    function updateSelectAll() {
        const checkboxes = document.querySelectorAll('.element-delete-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        document.getElementById('selectAllOptionsDelete').checked = allChecked;
    }

    // Функция для обновления состояния чекбокса "Выбрать всё" для направлений
    function updateSelectAllDirections() {
        const checkboxes = document.querySelectorAll('.direction-checkbox-delete');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        document.getElementById('selectAllDirectionsDelete').checked = allChecked;
    }

    // Применяем эту логику после каждого изменения состояния чекбоксов
    document.querySelectorAll('.element-delete-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectAll);
    });

    document.querySelectorAll('.direction-checkbox-delete').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectAllDirections);
    });

    // Логика для дисциплин
    checkboxMap.disciplines.addEventListener('change', () => {
        if (checkboxMap.disciplines.checked) {
            // При выборе дисциплин активируются все зависимости
            checkboxMap.ze.checked = true;
            checkboxMap.dependent_disciplines.checked = true;
            checkboxMap.competence_discipline_links.checked = true;
            checkboxMap.indicator_discipline_links.checked = true;
        } else {
            // Если снимается дисциплина, снимаем только зачётные единицы
            checkboxMap.ze.checked = false;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для зачётных единиц
    checkboxMap.ze.addEventListener('change', () => {
        if (checkboxMap.ze.checked) {
            // При выборе зачётных единиц активируются дисциплины и все зависимости
            checkboxMap.disciplines.checked = true;
            checkboxMap.dependent_disciplines.checked = true;
            checkboxMap.competence_discipline_links.checked = true;
            checkboxMap.indicator_discipline_links.checked = true;
        } else {
            // Если снимается зачётная единица, снимаем дисциплины
            checkboxMap.disciplines.checked = false;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для компетенций
    checkboxMap.competences.addEventListener('change', () => {
        if (checkboxMap.competences.checked) {
            // При выборе компетенций активируются связи компетенция-дисциплина, индикатор-дисциплина и индикаторы
            checkboxMap.competence_discipline_links.checked = true;
            checkboxMap.indicator_discipline_links.checked = true;
            checkboxMap.indicators.checked = true;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для индикаторов
    checkboxMap.indicators.addEventListener('change', () => {
        if (checkboxMap.indicators.checked) {
            // При выборе индикаторов активируется связь индикатор-дисциплина
            checkboxMap.indicator_discipline_links.checked = true;
        } else {
            // Если убираются индикаторы, снимаем галочку с компетенций
            checkboxMap.competences.checked = false;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для связи индикатор-дисциплина
    checkboxMap.indicator_discipline_links.addEventListener('change', () => {
        if (!checkboxMap.indicator_discipline_links.checked) {
            // Если снимается связь индикатор-дисциплина, снимаем индикатор
            checkboxMap.indicators.checked = false;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для связи компетенция-дисциплина
    checkboxMap.competence_discipline_links.addEventListener('change', () => {
        if (!checkboxMap.competence_discipline_links.checked) {
            // Если снимается связь компетенция-дисциплина, снимаем компетенции
            checkboxMap.competences.checked = false;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для снятия галочки с компетенций, если убираются связи
    checkboxMap.indicator_discipline_links.addEventListener('change', () => {
        if (!checkboxMap.indicator_discipline_links.checked) {
            // Если снимается связь индикатор-дисциплина, снимаем компетенции
            checkboxMap.competences.checked = false;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для снятия галочки с дисциплин, если убираются зачётные единицы
    checkboxMap.ze.addEventListener('change', () => {
        if (!checkboxMap.ze.checked) {
            // Если снимаются зачётные единицы, снимаем дисциплины
            checkboxMap.disciplines.checked = false;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для снятия галочки с дисциплин, если убираются зависимости
    checkboxMap.dependent_disciplines.addEventListener('change', () => {
        if (!checkboxMap.dependent_disciplines.checked) {
            // Если снимаются зависимые дисциплины, снимаем дисциплины
            checkboxMap.disciplines.checked = false;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для снятия галочки с дисциплин, если убираются связи
    checkboxMap.competence_discipline_links.addEventListener('change', () => {
        if (!checkboxMap.competence_discipline_links.checked) {
            // Если снимаются связи дисциплины, снимаем дисциплины
            checkboxMap.disciplines.checked = false;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для снятия галочки с компетенций, если убираются связи
    checkboxMap.indicator_discipline_links.addEventListener('change', () => {
        if (!checkboxMap.indicator_discipline_links.checked) {
            // Если снимаются связи индикатор-дисциплина, снимаем компетенции
            checkboxMap.competences.checked = false;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для снятия галочки с индикаторов, если убираются связи
    checkboxMap.indicator_discipline_links.addEventListener('change', () => {
        if (!checkboxMap.indicator_discipline_links.checked) {
            // Если снимаются связи индикатор-дисциплина, снимаем индикаторы
            checkboxMap.indicators.checked = false;
        }
        updateSelectAll(); // Обновляем состояние "Выбрать все"
    });

    // Логика для обновления чекбокса "Выбрать всё" для направлений
    document.getElementById('selectAllDirectionsDelete').addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('.direction-checkbox-delete');
        checkboxes.forEach(cb => {
            cb.checked = e.target.checked;
        });
        updateSelectAllDirections(); // Обновляем состояние "Выбрать все" для направлений
    });


    // Если отключили любой из зависимых чекбоксов — отключается дисциплина
    const disciplineDependencies = ['ze', 'competence_discipline_links', 'indicator_discipline_links', 'dependent_disciplines'];
    disciplineDependencies.forEach(key => {
        checkboxMap[key].addEventListener('change', () => {
            const anyDependentChecked = disciplineDependencies.some(k => checkboxMap[k].checked);
            if (!anyDependentChecked) {
                checkboxMap.disciplines.checked = false;
            }
        });
    });
});
</script>




{% endblock %}
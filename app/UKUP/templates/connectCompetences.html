{% extends "Sidebar.html" %}
{% block content %}
{{ super() }}
<div class="content container-fluid">

  <!-- Заголовок страницы -->
  <div class="page-header mb-4">
    <h3 class="text-center mb-4">
      Год приёма: {{ current_year }} | Направление: {{ current_direction.code }} {{ current_direction.name }}
    </h3>
  </div>

  <!-- Карточка с информацией о дисциплине -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
      <h5 class="card-title mb-0">Информация о дисциплине</h5>
    </div>
    <div class="card-body">
      <p class="card-text">
        <strong>{{ discipline.name }}</strong><br>
        Блок: {{ discipline.block.name }}<br>
        Модуль: {{ discipline.module.name }}<br>
        Кафедра: {{ discipline.department.name }}
      </p>
    </div>
    <div style="display:none;" id="block_id">{{ discipline.block_id }}</div>
  </div>

  <!-- Форма для выбора компетенций -->
  <form method="post" class="mb-4">
    <input name="current_year" id="year" type="hidden" value="{{ current_year }}">
    <input name="current_direction" id="direction" type="hidden" value="{{ current_direction.id }}">
    {{ form.csrf_token }}

    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">Связанные компетенции</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-bordered table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th class="text-center col-1">Выбрать</th>
                <th class="col-2">Код компетенции</th>
                <th class="col-9">Формулировка компетенции</th>
              </tr>
            </thead>
            <tbody>
              {{ form.hidden(id="hidden", value=checked) }}
              {% for competence in competences %}
              <tr class="this" name="competence">
                <td class="text-center align-middle">
                  {{ form.connect(value=competence.id, id="connect-{}".format(competence.id)) }}
                </td>
                <td class="align-middle">{{ competence.name }}</td>
                <td class="align-middle">{{ competence.formulation }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Блок с ошибками -->
    <div class="errors alert alert-danger mt-3 mb-3 text-center" id="errors" style="display: none;">
      Дисциплины из блока Б1.В.ОД, Б1.В.ВД, Б2.В не должны быть связаны с профессиональными компетенциями
    </div>

    <!-- Кнопки действий -->
    <div class="row mt-4">
      <div class="col-md-6 mb-2 mb-md-0">
        {{ form.submit(value="Сохранить изменения", class="btn btn-primary w-100") }}
      </div>
      <div class="col-md-6">
        <form action="/UKUP/discipline/{{ discipline.id }}/indicators" method="get" class="w-100">
          <input name="year" id="year2" type="hidden" value="{{ current_year }}">
          <input name="direction" id="direction2" type="hidden" value="{{ current_direction.id }}">
          <input type="submit" class="btn btn-secondary w-100" value="Перейти к индикаторам">
        </form>
      </div>
    </div>
  </form>
</div>

<script>
  // Инициализация выбранных компетенций
  var hidden = JSON.parse(document.getElementById("hidden").value);
  for (let competence_id in hidden){
    document.getElementById(`connect-${hidden[competence_id]}`).checked = true
  }

  // Проверка валидации
  window.addEventListener("load", function () {
    var err_count = 0;
    var name = document.getElementsByName("competence");
    var block_id = Number(document.getElementById("block_id").innerHTML);
    var error_block = document.getElementById("errors");

    name.forEach(function (item) {
      var checkbox = item.querySelector("input[type='checkbox']");
      var type = checkbox.parentElement.nextElementSibling;
      type = type.innerHTML.split("-")[0];

      if (type == "ПК" && [2, 3, 5].includes(block_id)) {
        if (checkbox.checked) {
          item.style.backgroundColor = "rgba(255,0,0,0.2)";
          err_count += 1;
        } else {
          item.style.backgroundColor = "";
        }
      }

      if (err_count > 0) {
        error_block.style.display = "block";
      } else {
        error_block.style.display = "none";
      }

      checkbox.addEventListener('change', (event) => {
        if (type == "ПК" && [2, 3, 5].includes(block_id)) {
          if (checkbox.checked) {
            item.style.backgroundColor = "rgba(255,0,0,0.2)";
            err_count += 1;
          } else {
            item.style.backgroundColor = "";
            err_count -= 1;
          }
          error_block.style.display = err_count > 0 ? "block" : "none";
        }
      });
    });
  });
</script>
{% endblock %}
